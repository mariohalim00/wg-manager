# name: CI

# on:
#   push:
#     branches: [main, feat/*, chore/*]
#   pull_request:
#     branches: [main]

# jobs:
#   # Backend: TDD mandatory (Constitution I)
#   backend-test:
#     name: Backend Tests
#     runs-on: ubuntu-latest
#     defaults:
#       run:
#         working-directory: backend

#     steps:
#       - uses: actions/checkout@v4

#       - name: Setup Go
#         uses: actions/setup-go@v5
#         with:
#           go-version: '1.25.6'
#           cache-dependency-path: backend/go.sum

#       - name: Download dependencies
#         run: go mod download

#       - name: Run tests
#         run: go test ./... -v -race -coverprofile=coverage.out

#       - name: Check test coverage
#         run: |
#           go tool cover -func=coverage.out
#           COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
#           echo "Total coverage: ${COVERAGE}%"
#           if (( $(echo "$COVERAGE < 70" | bc -l) )); then
#             echo "Coverage is below 70%"
#             exit 1
#           fi

#       - name: Upload coverage to artifacts
#         uses: actions/upload-artifact@v4
#         with:
#           name: backend-coverage
#           path: backend/coverage.out

#   backend-lint:
#     name: Backend Linting
#     runs-on: ubuntu-latest
#     defaults:
#       run:
#         working-directory: backend

#     steps:
#       - uses: actions/checkout@v4

#       - name: Setup Go
#         uses: actions/setup-go@v5
#         with:
#           go-version: '1.25.6'
#           cache-dependency-path: backend/go.sum

#       - name: Run go vet
#         run: go vet ./...

#       - name: Check formatting
#         run: |
#           gofmt -l . > fmt_output.txt
#           if [ -s fmt_output.txt ]; then
#             echo "The following files are not formatted:"
#             cat fmt_output.txt
#             exit 1
#           fi

#   backend-build:
#     name: Backend Build
#     runs-on: ubuntu-latest
#     defaults:
#       run:
#         working-directory: backend

#     steps:
#       - uses: actions/checkout@v4

#       - name: Setup Go
#         uses: actions/setup-go@v5
#         with:
#           go-version: '1.25.6'
#           cache-dependency-path: backend/go.sum

#       - name: Build binary
#         run: go build -v -o ../bin/wg-manager ./cmd/server

#       - name: Upload binary
#         uses: actions/upload-artifact@v4
#         with:
#           name: backend-binary
#           path: bin/wg-manager

#   # Frontend: UX/Performance focus, no tests required (Constitution II)
#   frontend-typecheck:
#     name: Frontend Type Check
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       - name: Setup Node
#         uses: actions/setup-node@v4
#         with:
#           node-version: 'lts/*'
#           cache: 'npm'

#       - name: Install dependencies
#         run: npm ci

#       - name: Run type check
#         run: npm run check

#   frontend-lint:
#     name: Frontend Linting
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       - name: Setup Node
#         uses: actions/setup-node@v4
#         with:
#           node-version: 'lts/*'
#           cache: 'npm'

#       - name: Install dependencies
#         run: npm ci

#       - name: Run linter
#         run: npm run lint

#   frontend-build:
#     name: Frontend Build & Performance Check
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       - name: Setup Node
#         uses: actions/setup-node@v4
#         with:
#           node-version: 'lts/*'
#           cache: 'npm'

#       - name: Install dependencies
#         run: npm ci

#       - name: Build frontend
#         run: npm run build

#       - name: Check bundle size (Constitution V - Performance Budget)
#         run: |
#           # Check that total bundle size is under 200KB gzipped
#           cd .svelte-kit/output/client/_app/immutable
#           TOTAL_SIZE=$(find . -name "*.js" -exec gzip -c {} \; | wc -c)
#           TOTAL_SIZE_KB=$((TOTAL_SIZE / 1024))
#           echo "Total bundle size (gzipped): ${TOTAL_SIZE_KB}KB"
#           if [ $TOTAL_SIZE_KB -gt 200 ]; then
#             echo "❌ Bundle size exceeds 200KB limit (Constitution V)"
#             exit 1
#           fi
#           echo "✅ Bundle size within budget: ${TOTAL_SIZE_KB}KB / 200KB"

#       - name: Upload build artifacts
#         uses: actions/upload-artifact@v4
#         with:
#           name: frontend-build
#           path: .svelte-kit/output

#   # API Contract Validation (Constitution III)
#   api-contract-check:
#     name: API Contract Validation
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       - name: Check API documentation exists
#         run: |
#           if [ ! -f backend/API.md ]; then
#             echo "❌ API.md is missing (Constitution III)"
#             exit 1
#           fi
#           echo "✅ API documentation found"

#       - name: Validate API endpoints are documented
#         run: |
#           # Check that all handler methods are documented in API.md
#           ENDPOINTS=$(grep -E "HandleFunc.*/" backend/cmd/server/main.go | wc -l)
#           DOCUMENTED=$(grep -E "^### [0-9]+\." backend/API.md | wc -l)
#           echo "Endpoints in code: $ENDPOINTS"
#           echo "Documented endpoints: $DOCUMENTED"
#           if [ $ENDPOINTS -ne $DOCUMENTED ]; then
#             echo "⚠️  Warning: Endpoint count mismatch"
#           fi

#   # Constitution Compliance Check
#   constitution-check:
#     name: Constitution Compliance
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       - name: Verify constitution exists
#         run: |
#           if [ ! -f .specify/memory/constitution.md ]; then
#             echo "⚠️  Warning: Constitution not found"
#             exit 0
#           fi
#           echo "✅ Constitution found"

#       - name: Check for hardcoded secrets (Constitution IV)
#         run: |
#           # Check for common secret patterns (excluding test files)
#           if grep -r -E "(password|secret|api_key|apikey).*=.*['\"][^'\"]{8,}" --include="*.go" --include="*.ts" --include="*.js" --exclude-dir=node_modules --exclude="*_test.go" .; then
#             echo "❌ Potential hardcoded secrets found (Constitution IV)"
#             exit 1
#           fi
#           echo "✅ No hardcoded secrets detected"

#   # Summary job - all checks must pass
#   ci-success:
#     name: CI Success
#     runs-on: ubuntu-latest
#     needs:
#       - backend-test
#       - backend-lint
#       - backend-build
#       - frontend-typecheck
#       - frontend-lint
#       - frontend-build
#       - api-contract-check
#       - constitution-check

#     steps:
#       - name: All checks passed
#         run: |
#           echo "✅ All CI checks passed!"
#           echo "Backend: Tests, linting, and build successful"
#           echo "Frontend: Type checking, linting, build, and performance budget met"
#           echo "API: Contract validation passed"
#           echo "Constitution: Compliance verified"
